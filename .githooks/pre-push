#!/bin/bash
# Pre-push hook: Verify tests have been run for HEAD
#
# Workflow:
#   1. Run .githooks/test-and-log.sh → writes teststats/pending.jsonl
#   2. git commit → post-commit hook promotes pending → git note
#   3. git push → this hook verifies note exists; notes push automatically
#
# Install: git config core.hooksPath .githooks

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if setup has been run
source "$SCRIPT_DIR/check-setup.sh"
if ! check_setup; then
  echo "Push blocked until setup is complete."
  exit 1
fi

echo "========================================"
echo "Pre-push hook: Checking tests..."
echo "========================================"

CURRENT_COMMIT=$(git rev-parse HEAD)
CURRENT_SHORT=$(git rev-parse --short HEAD)

if git notes --ref=test-results show "$CURRENT_COMMIT" >/dev/null 2>&1; then
  echo "✅ Test note exists for commit $CURRENT_SHORT — push allowed"
  exit 0
fi

echo ""
echo "⚠️  No test note for commit $CURRENT_SHORT."
echo "   Run:  .githooks/test-and-log.sh && git commit --amend --no-edit"
echo "   Pushing without test results..."
exit 0

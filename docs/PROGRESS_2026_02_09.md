# Progress Report: February 9, 2026

## Summary

Major breakthrough in RNG alignment, achieving **87.2% test pass rate** (650/745 tests passing). Fixed critical pet trap avoidance logic and wizard mode trap visibility issues.

## Test Results

### Before (baseline)
- Comparison tests: 629 pass / 116 fail (84.4%)

### After
- Comparison tests: **650 pass / 95 fail (87.2%)**
- **+21 tests passing** (+2.8 percentage points)
- Unit tests: 454 pass / 0 fail âœ“

## Key Achievements

### 1. Pet Trap Avoidance Implementation

**Commit**: `bdc2644`

Implemented C's `dogmove.c:1182-1204` trap avoidance logic:
- Added `m_harmless_trap()` function with full trap immunity checks
- Flyers ignore floor traps (M1_FLY flag)
- Resistances properly checked (MR_FIRE, MR_SLEEP, etc.)
- Pets avoid harmful seen traps with 39/40 probability via `rn2(40)`

**Files modified**:
- `js/monmove.js`: +55 lines

### 2. Wizard Mode Trap Omniscience

**Commit**: `03b7d8e`

**Root cause discovered**: C test harness runs with `-D` (wizard mode) flag, which automatically reveals all traps. JS wasn't simulating this omniscience.

**Fix**: Set `trap.tseen = true` for all traps after makelevel in test helpers.

**Impact**:
- seed2_wizard_fountains: **24 more steps pass** (5-29, previously failed at step 5)
- Multiple other gameplay sessions now pass more steps
- Pet trap avoidance now fires correctly because traps are visible

**Files modified**:
- `test/comparison/session_helpers.js`: +13 lines

### 3. Earlier Fixes Merged from shops Branch

**Commit**: `9efefa6` - STR18 encoding + post-level init
- Fixed STR18 attrmax encoding (118 for 18/100 strength)
- Added `simulatePostLevelInit()` to map sessions for depth 1
- Result: All 5 map seeds achieve **perfect depth-1 alignment**

**Commit**: `a996bb5` - may_generate_eroded fix
- Fixed object erosion generation logic
- Added `is_damageable()` check matching C

## Technical Insights

### Wizard Mode vs Wizard (role)

Critical distinction:
- **wizard mode** (`-D` flag): Debug mode with trap omniscience
- **Wizard**: Character class (roleIndex = 12)

C harness command:
```bash
nethack -u Wizard -D  # Player named "Wizard", wizard mode enabled
```

This means:
- All traps visible from start (`trap.tseen = true`)
- Pet trap avoidance logic always fires
- JS must simulate this in test environment

### STR18 Encoding

NetHack 3.7 encodes exceptional strength (18/xx) as `18 + x`:
```c
#define STR18(x) (18 + (x))
STR18(100) = 118  // 18/100 strength
STR18(50)  = 68   // 18/50 strength
```

Race maximums:
- Human/Dwarf: 118 (can achieve 18/100)
- Gnome/Orc: 68 (can achieve 18/50)
- Elf: 18 (plain, no exceptional strength)

### RNG Counting

Correct filtering excludes:
- Composite entries: `d(6,6)=17`, `rne(4)=2`
- Midlog markers: `>function`, `<function`

Only count: `rn2(n)`, `rnd(n)`, `rn1(hi,x)` entries.

## Remaining Work

### Map Generation (depth 2+)

**Known issues**:
- Seeds 119, 72: Diverge ~65 calls from end of depth 2 (`place_lregion`)
- Seeds 163, 306: Diverge mid-generation (branch placement)
- Seed 16: Diverges at monster init

**Missing C functions**:
- `fixup_special()` - Post-level branch connection fixup
- `place_lregion()` - Probabilistic feature placement with rn1() loop
- Full branch placement for depths > 1

### Gameplay Sessions

**Current failures**:
- seed2 step 30: open-move-east (door opening mechanics)
- seed1 step 67: Descend to depth 2 (map gen differences cascade)
- seed42: Test isolation issue (passes alone, fails in suite)
- seed42_inventory: Modal input handling (nhgetch dismissal)

### Test Infrastructure

**Improvements needed**:
- Test isolation: Reset global state between tests
- Modal input: Queue dismissal keys for inventory/menus
- Depth 2+ wizard teleport simulation

## Files Changed

```
js/mkobj.js                        | 28 ++++++----
js/monmove.js                      | 56 ++++++++++++++++++-
js/u_init.js                       |  9 ++--
test/comparison/session_helpers.js | 35 ++++++++++--
docs/RNG_ALIGNMENT_GUIDE.md        | NEW FILE (comprehensive)
docs/PROGRESS_2026_02_09.md        | NEW FILE (this file)
```

## Next Steps

1. **Investigate seed2 step 30**: Door opening + movement interaction
2. **Implement place_lregion**: For depth 2 map alignment
3. **Fix test isolation**: Prevent state leakage between tests
4. **Document depth 2+ divergences**: Create detailed analysis

## Commits Merged to Main

```
03b7d8e Enable wizard mode trap omniscience in test helpers
bdc2644 Add pet trap avoidance logic to dog_move
9efefa6 Fix STR18 attrmax + add post-level init to map sessions
a996bb5 Fix may_generate_eroded: add is_damageable check
```

## Conclusion

Significant progress toward full RNG alignment. The wizard mode trap visibility fix was a major breakthrough, demonstrating the importance of understanding the C test harness environment. With 87.2% of tests passing and perfect depth-1 map alignment, the codebase is in excellent shape for continued incremental improvements.

The comprehensive `RNG_ALIGNMENT_GUIDE.md` captures all lessons learned and provides a solid foundation for future debugging work.
